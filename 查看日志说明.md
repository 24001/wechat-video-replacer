# 超详细日志版本 - 问题定位指南

## 🔍 新版本特点

**版本**：v1.1 (74KB)
**特点**：每一步都有超详细的日志输出

## 📋 测试步骤

### 1. 安装新版本

1. **卸载旧版本** + **重启设备**
2. 安装 `build/WechatVideoReplacer.ipa` (74KB)

### 2. 清除缓存（强烈建议）

1. 打开应用
2. 点击底部右侧 **"🗑️ 清除缓存"** 按钮
3. 确认清除

### 3. 测试一键替换

#### 步骤A：选择素材

1. 点击 "选择素材"，选择一个视频
2. 看到素材信息显示

#### 步骤B：微信准备

1. 打开微信
2. 进入朋友圈或视频号发布
3. 录制或选择一个视频
4. **不要发布！** 停留在编辑页面

#### 步骤C：执行替换并观察日志

1. 返回我们的应用
2. 点击 "一键替换" → "开始替换"

## 📝 关键日志节点

新版本会在每个关键点输出详细日志，通过 Xcode Console 或 Console.app 查看：

### 🔍 Pre-fetch 阶段

```
🔍 [Prefetch] 预先获取微信容器路径...
✅ [Prefetch] 成功：路径已缓存
   - 路径: /var/mobile/Containers/Data/Application/91FC0093-.../tmp
```

**如果这里失败**：说明基础权限有问题

### 🚀 主流程开始

```
🚀 [VideoViewModel] ========== 开始一键替换流程 ==========

📝 [步骤1] 验证素材...
✅ [步骤1] 成功：素材已选择
   - 文件名: IMG_1234.MOV
   - 大小: 15.2 MB
   - 时长: 00:32
```

### 📝 步骤2A：使用缓存路径

```
📝 [步骤2A] 使用缓存的微信容器路径...
   - 当前线程: <_NSMainThread: ...>
   - 是否主线程: true
✅ [步骤2A] 成功：使用缓存路径
   - 路径: /var/mobile/Containers/Data/Application/.../tmp
```

### 📝 步骤2B：导出视频

```
📝 [步骤2B] 从相册导出视频（后台线程）...
   - 当前线程: <NSThread: ...>  ← 后台线程
   - 是否主线程: false
   - AssetID: 12345678-ABCD-EF12...

✅ [步骤2B] 成功：视频导出完成
   - 临时路径: /var/tmp/临时文件路径
   - 文件名: IMG_1234.MOV

📝 [步骤2B] 切换回主线程继续...
   - 当前线程: <_NSMainThread: ...>  ← 关键！必须是主线程
   - 是否主线程: true
```

### 📝 步骤3：上传到微信 tmp

```
📝 [步骤3] 上传素材到微信 tmp...
   - 当前线程: <_NSMainThread: ...>  ← 必须是主线程！
   - 是否主线程: true
   - 源文件: /var/tmp/...
   - 目标路径: /var/mobile/Containers/.../tmp/IMG_1234.MOV
   - 微信 tmp 存在: true, 是目录: true  ← 关键检查点

📋 [FileService] 开始复制文件...
   - 当前线程: <_NSMainThread: ...>
   - 是否主线程: true
   - 源文件存在: true
   - 源文件大小: 15987456 bytes
   - 目标目录存在: true, 是目录: true
   - 开始复制...
   - 复制完成，目标文件存在: true

✅ [步骤3] 成功：素材已上传到微信
```

**如果步骤3失败**：
- 检查 "微信 tmp 存在" 是否为 true
- 检查 "目标目录存在" 是否为 true
- 检查是否在主线程执行

### 📝 步骤4：查找缓存文件

```
📝 [步骤4] 查找最新视频缓存...
   - 当前线程: <_NSMainThread: ...>
   - 是否主线程: true
   - 查找路径: /var/mobile/Containers/.../tmp
   - 查找前缀: LocalShortVideo
   - tmp 目录存在: true, 是目录: true
   - tmp 目录包含 15 个文件
   - 其中 LocalShortVideo 文件: 1 个
     • LocalShortVideo_1641234567.mp4

✅ [步骤4] 成功：找到最新缓存
   - 缓存文件: LocalShortVideo_1641234567.mp4
```

**如果步骤4失败**：
- 检查 "LocalShortVideo 文件: X 个" - 应该 > 0
- 如果是 0，说明微信还没有创建草稿

### 📝 步骤5：替换文件

```
📝 [步骤5] 执行文件替换...
   - 当前线程: <_NSMainThread: ...>
   - 是否主线程: true
   - 我们的文件: IMG_1234.MOV
   - 替换目标: LocalShortVideo_1641234567.mp4
   - 操作目录: /var/mobile/Containers/.../tmp
   - 我们文件存在: true
   - 缓存文件存在: true

✅ [步骤5] 成功：文件替换完成

🎉 一键替换流程完成！
```

## 🚨 常见失败点分析

### 失败点1：Pre-fetch 失败

```
❌ [Prefetch] 失败：找不到微信应用
```

**原因**：基础权限问题或微信未安装
**解决**：
1. 确保微信已安装
2. 点击 "🔍 系统诊断" 查看是否能找到微信容器

### 失败点2：步骤3 微信 tmp 不存在

```
📝 [步骤3] 上传素材到微信 tmp...
   - 微信 tmp 存在: false, 是目录: false
❌ [步骤3] 微信 tmp 目录不存在！
```

**原因**：缓存的路径已经失效
**解决**：应用会自动重新定位，如果还是失败说明权限问题

### 失败点3：FileService 复制失败

```
📋 [FileService] 开始复制文件...
   - 源文件存在: true
   - 目标目录存在: false, 是目录: false  ← 问题在这里
❌ [FileService] 复制失败: ...
```

**原因**：目标目录权限问题或路径错误

### 失败点4：找不到 LocalShortVideo

```
📝 [步骤4] 查找最新视频缓存...
   - tmp 目录包含 12 个文件
   - 其中 LocalShortVideo 文件: 0 个  ← 问题在这里
❌ [步骤4] 失败：未找到微信视频缓存
```

**原因**：微信还没有创建视频草稿
**解决**：
1. 在微信中重新创建视频草稿
2. 确保停留在编辑页面（不要发布）

## 🔧 问题排查流程

### 1. 确认基础状态

1. 点击 "🔍 系统诊断"
2. 确认能找到微信容器：`com.tencent.xin`

### 2. 查看完整日志

使用 Console.app 或 Xcode Console，搜索 "WechatVideoReplacer"

### 3. 对比预期输出

将你的日志与上面的"关键日志节点"对比，找到第一个失败的地方

### 4. 针对性修复

- **Pre-fetch 失败**：权限问题
- **步骤3失败**：线程或权限问题  
- **步骤4失败**：微信草稿问题
- **步骤5失败**：文件操作问题

## 📨 反馈格式

如果还是失败，请提供：

1. **失败步骤**：在第几步失败的
2. **完整日志**：从 "🚀 ========== 开始一键替换流程" 到错误结束的完整日志
3. **系统诊断结果**：点击 "🔍 系统诊断" 的完整输出

这样我们就能精确定位问题所在！

---

**当前版本**：v1.1 超详细日志版 (74KB)
**构建时间**：2025-11-11 00:30
**特点**：每个步骤都有线程信息和状态检查
