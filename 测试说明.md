# 最新修复版本测试说明

## 🐛 真正的问题

经过深入分析，发现了真正的问题：

### 问题根源：线程限制

**iOS 私有 entitlements 权限只在主线程有效！**

```
正确流程（主线程）：
Button Tap [主线程]
  → prefetch 微信路径 [主线程] ✅ 权限有效
  → 导出视频 [后台线程] ✅ 不需要容器权限
  → 切换回主线程 [主线程]  ✅ 关键修复！
  → 写入微信 tmp [主线程] ✅ 权限有效
  → 查找缓存文件 [主线程] ✅ 权限有效
  → 替换文件 [主线程] ✅ 权限有效

错误流程（之前的版本）：
Button Tap [主线程]
  → prefetch 微信路径 [主线程] ✅ 
  → 导出视频 [后台线程] ✅
  → 写入微信 tmp [后台线程] ❌ 权限失效！
```

### 关键修改

**VideoViewModel.swift - 第 175-184 行**：

```swift
case .success(let (tempPath, fileName)):
    print("✅ [步骤2B] 成功：视频导出完成")
    
    // ⚠️ 重要：必须回到主线程执行后续操作
    // 因为访问微信容器需要私有权限，而这些权限可能只在主线程有效
    DispatchQueue.main.async {
        self.onStatusUpdate?("导出成功，正在上传素材...")
        print("📝 [步骤2B] 切换回主线程继续...")
        print("   - 是否主线程: \(Thread.isMainThread)")
        
        // 在主线程执行后续操作
        self.proceedWithUpload(...)  // ← 现在在主线程执行！
    }
```

**之前的错误**：
```swift
// 错误：在后台线程直接执行
self.proceedWithUpload(...)  // ❌ 后台线程，权限失效！
```

## ✅ 新增功能

### 1. 清除缓存按钮

- 位置：底部右侧
- 功能：
  - 清除素材缓存
  - 清除微信路径缓存
  - 清除所有 UserDefaults
- 用途：重置应用状态，方便测试

### 2. 完整的线程日志

所有操作都会输出：
```
- 当前线程: <NSThread: ...>
- 是否主线程: true/false
```

方便调试和验证。

## 📋 测试步骤

### 第1步：清理旧版本

1. **打开 TrollStore**
2. **卸载旧版本** "微信视频替换工具"
3. **重启设备**（重要！清除系统权限缓存）

### 第2步：安装新版本

1. 通过 TrollStore 安装：`build/WechatVideoReplacer.ipa` (70KB)
2. 打开应用

### 第3步：清除缓存（可选）

如果还有旧数据：
1. 点击底部右侧 **"🗑️ 清除缓存"** 按钮
2. 确认清除

### 第4步：完整测试

#### 测试1：系统诊断

1. 点击底部左侧 **"🔍 系统诊断"**
2. 应该看到：
   - ✅ 扫描到 200+ 容器
   - ✅ 找到微信应用
   - ✅ 微信容器 UUID

#### 测试2：一键替换

1. **选择素材**：
   - 点击 "选择素材"
   - 从相册选择一个视频

2. **在微信中创建草稿**：
   - 打开微信
   - 进入朋友圈或视频号
   - 点击发布视频
   - 录制或选择一个视频
   - **不要发布！** 留在编辑页面
   - 返回应用

3. **执行替换**：
   - 点击 "一键替换" 按钮
   - 点击 "开始替换"
   - 观察状态消息：
     ```
     正在从相册导出素材...
     导出成功，正在上传素材...
     素材已上传，正在查找最新缓存...
     找到缓存文件，正在替换...
     替换成功！可以去微信发布了 ✓
     ```

4. **验证结果**：
   - 返回微信
   - 视频应该已经被替换成你的素材了
   - 点击发布

## 📝 查看日志

如果遇到问题，查看详细日志：

### 方法1：Xcode Console（推荐）

1. 连接设备到 Mac
2. Xcode → Window → Devices and Simulators
3. 选择设备 → Open Console
4. 搜索 "WechatVideoReplacer"

### 方法2：Console.app（系统自带）

1. 打开 /Applications/Utilities/Console.app
2. 选择你的设备
3. 搜索 "WechatVideoReplacer"

### 关键日志标识

成功的日志应该显示：

```
🔍 [Prefetch] 预先获取微信容器路径...
✅ [Prefetch] 成功：路径已缓存
   - 路径: /var/mobile/Containers/Data/Application/.../tmp

🚀 [VideoViewModel] ========== 开始一键替换流程 ==========

📝 [步骤2A] 使用缓存的微信容器路径...
   - 当前线程: <_NSMainThread: ...>
   - 是否主线程: true
✅ [步骤2A] 成功：使用缓存路径

📝 [步骤2B] 从相册导出视频（后台线程）...
   - 当前线程: <NSThread: ...>  ← 后台线程
   - 是否主线程: false
✅ [步骤2B] 成功：视频导出完成

📝 [步骤2B] 切换回主线程继续...
   - 当前线程: <_NSMainThread: ...>
   - 是否主线程: true  ← 关键！已切换回主线程

📝 [步骤3] 上传素材到微信 tmp...
   - 当前线程: <_NSMainThread: ...>  ← 主线程
✅ [步骤3] 成功：素材已上传到微信

📝 [步骤4] 查找最新视频缓存...
✅ [步骤4] 成功：找到最新缓存

📝 [步骤5] 执行文件替换...
✅ [步骤5] 成功：替换完成
```

**如果失败**，应该能看到具体的错误信息和诊断输出。

## 🎯 预期结果

- ✅ 系统诊断正常
- ✅ 一键替换成功
- ✅ 所有操作都在正确的线程执行
- ✅ 微信草稿视频被成功替换

## 🔧 如果还是失败

1. **点击 "🗑️ 清除缓存"** 清理所有缓存
2. **完全卸载** + **重启设备**
3. **重新安装**新版本（70KB）
4. **查看完整日志**，找到失败的具体步骤
5. 复制日志给我分析

---

## 📚 技术总结

### iOS 私有 Entitlements 的限制

通过测试发现：

1. **主线程限制**：
   - 私有权限（如 `com.apple.private.MobileContainerManager.allowed`）只在主线程有效
   - 后台线程无法使用这些权限访问容器

2. **UIAlertController 限制**：
   - UIAlertController callback 中获取权限可能失效
   - 解决方案：提前缓存路径（Pre-fetch）

3. **最佳实践**：
   - 所有需要容器权限的操作都在主线程执行
   - 只有纯粹的数据处理（如导出视频）可以在后台线程
   - 获取容器路径后立即缓存，避免重复获取

### 修复的三个关键点

1. ✅ **Pre-fetch**：在 UIAlertController 前获取并缓存路径
2. ✅ **Main Thread**：所有容器操作回到主线程
3. ✅ **Clear Cache**：添加清除缓存功能，方便测试

---

**版本**：v1.0 (70KB)
**构建时间**：2025-11-11 00:19
**关键修复**：主线程限制
