# å¾®ä¿¡è§†é¢‘æ›¿æ¢å·¥å…· - æŠ€æœ¯å®ç°æ–¹æ¡ˆ

> åŸºäºå·²éªŒè¯æˆåŠŸçš„å®¹å™¨è®¿é—®æŠ€æœ¯

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
2. [æƒé™é…ç½®](#æƒé™é…ç½®)
3. [æ ¸å¿ƒä»£ç å®ç°](#æ ¸å¿ƒä»£ç å®ç°)
4. [æ„å»ºå’Œæ‰“åŒ…](#æ„å»ºå’Œæ‰“åŒ…)
5. [å·²å®Œæˆçš„ä»£ç ](#å·²å®Œæˆçš„ä»£ç )
6. [å¾…å®ç°çš„åŠŸèƒ½](#å¾…å®ç°çš„åŠŸèƒ½)

---

## 1. æŠ€æœ¯æ¶æ„

### 1.1 æ•´ä½“æ¶æ„

```
ç”¨æˆ·ç•Œé¢ (ViewController)
    â†“
ä¸šåŠ¡é€»è¾‘ (VideoViewModel)
    â†“
æœåŠ¡å±‚ (Services)
    â”œâ”€â”€ VideoService - ç›¸å†Œæ“ä½œ
    â”œâ”€â”€ WechatService - å¾®ä¿¡å®¹å™¨æ“ä½œ
    â””â”€â”€ FileService - æ–‡ä»¶æ“ä½œ
    â†“
æ•°æ®å±‚ (Models + Storage)
```

### 1.2 æŠ€æœ¯æ ˆ

- **è¯­è¨€**ï¼šSwift 5.0+
- **UI æ¡†æ¶**ï¼šUIKit
- **æ¶æ„æ¨¡å¼**ï¼šMVVM
- **æœ€ä½ iOS**ï¼š14.0
- **è®¾å¤‡**ï¼šiPad
- **ç­¾åå·¥å…·**ï¼šldid

### 1.3 å®¹å™¨è®¿é—®æ–¹æ¡ˆ

**âœ… æœ€ç»ˆæ–¹æ¡ˆï¼šç›´æ¥è®¿é—®ï¼ˆæ— éœ€ RootHelperï¼‰**

- ä½¿ç”¨ `com.apple.private.security.container-manager` entitlement
- é€šè¿‡ FileManager ç›´æ¥è¯»å– `/var/mobile/Containers/`
- ä¸éœ€è¦ root æƒé™
- ä¸éœ€è¦ roothelper binary

**âŒ åºŸå¼ƒæ–¹æ¡ˆï¼šRootHelper**
- å°è¯•é€šè¿‡ `spawnRoot()` ç”Ÿæˆ root è¿›ç¨‹
- iOS 17.6+ æœ‰é™åˆ¶
- å®é™…ä¸éœ€è¦ root æƒé™
- å·²ç§»é™¤æ‰€æœ‰ç›¸å…³ä»£ç 

---

## 2. æƒé™é…ç½®

### 2.1 entitlements.plistï¼ˆå·²éªŒè¯å¯ç”¨ï¼‰

**å®Œæ•´é…ç½®**ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <!-- çªç ´æ²™ç›’é™åˆ¶ -->
    <key>com.apple.private.security.container-required</key>
    <false/>
    
    <!-- å¹³å°çº§åº”ç”¨æƒé™ -->
    <key>platform-application</key>
    <true/>
    
    <!-- ç»å¯¹è·¯å¾„è¯»å†™æ ¹ç›®å½• - Filza å…³é”®æƒé™ -->
    <key>com.apple.security.exception.files.absolute-path.read-write</key>
    <array>
        <string>/</string>
    </array>
    
    <!-- è®¿é—®æ‰€æœ‰æ–‡ä»¶ -->
    <key>com.apple.security.files.all</key>
    <true/>
    
    <!-- æ— å®¹å™¨é™åˆ¶ -->
    <key>com.apple.private.security.no-container</key>
    <true/>
    
    <!-- è®¿é—®åº”ç”¨æ•°æ®å®¹å™¨ - æ ¸å¿ƒæƒé™ -->
    <key>com.apple.private.security.storage.AppDataContainers</key>
    <true/>
    
    <!-- å®¹å™¨ç®¡ç†å™¨æƒé™ - æ ¸å¿ƒæƒé™ -->
    <key>com.apple.private.security.container-manager</key>
    <true/>
    
    <!-- Mobile Container Manager - Filza å…³é”®æƒé™ -->
    <key>com.apple.private.MobileContainerManager.allowed</key>
    <true/>
    
    <!-- ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶åªè¯» -->
    <key>com.apple.security.files.user-selected.read-only</key>
    <true/>
    
    <!-- ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶è¯»å†™ -->
    <key>com.apple.security.files.user-selected.read-write</key>
    <true/>
    
    <!-- æ ¹æ–‡ä»¶ç³»ç»Ÿåªè¯» -->
    <key>com.apple.security.files.root.read-only</key>
    <true/>
    
    <!-- æ ¹æ–‡ä»¶ç³»ç»Ÿè¯»å†™ -->
    <key>com.apple.security.files.root.read-write</key>
    <true/>
    
    <!-- è®¿é—®æ‰€æœ‰åº”ç”¨ç»„å®¹å™¨ -->
    <key>com.apple.security.application-groups</key>
    <array>
        <string>*</string>
    </array>
    
    <!-- ä»»åŠ¡ç«¯å£è®¿é—® -->
    <key>task_for_pid-allow</key>
    <true/>
    
    <!-- è·å–ä»»åŠ¡å…è®¸ -->
    <key>get-task-allow</key>
    <true/>
    
    <!-- ç¦ç”¨æ²™ç›’ -->
    <key>com.apple.private.security.no-sandbox</key>
    <true/>
    
    <!-- Persona ç®¡ç†æƒé™ -->
    <key>com.apple.private.persona-mgmt</key>
    <true/>
</dict>
</plist>
```

### 2.2 ä¸‰ä¸ªæ ¸å¿ƒæƒé™

è¿™ä¸‰ä¸ªæƒé™æ˜¯å®¹å™¨è®¿é—®çš„å…³é”®ï¼š

```xml
<!-- 1. ç»å¯¹è·¯å¾„è®¿é—® - å…è®¸è®¿é—®æ ¹ç›®å½• -->
<key>com.apple.security.exception.files.absolute-path.read-write</key>
<array><string>/</string></array>

<!-- 2. å®¹å™¨ç®¡ç†å™¨ - å…è®¸è¯»å–å®¹å™¨åˆ—è¡¨ -->
<key>com.apple.private.security.container-manager</key>
<true/>

<!-- 3. Mobile Container Manager - Filza ä½¿ç”¨çš„å…³é”®æƒé™ -->
<key>com.apple.private.MobileContainerManager.allowed</key>
<true/>
```

### 2.3 ç¦æ­¢ä½¿ç”¨çš„æƒé™

**âš ï¸ ä»¥ä¸‹æƒé™åœ¨ iOS 15+ A12+ è®¾å¤‡ä¸Šè¢«ç¦æ­¢ï¼Œä¼šå¯¼è‡´åº”ç”¨é—ªé€€ï¼š**

```xml
âŒ <key>com.apple.private.cs.debugger</key>
âŒ <key>com.apple.private.skip-library-validation</key>
âŒ <key>dynamic-codesigning</key>
```

### 2.4 Info.plist é…ç½®

```xml
<!-- ç›¸å†Œè®¿é—®æƒé™ -->
<key>NSPhotoLibraryUsageDescription</key>
<string>éœ€è¦è®¿é—®ç›¸å†Œä»¥é€‰æ‹©è¦ä¸Šä¼ çš„è§†é¢‘ç´ æ</string>
```

**æ³¨æ„**ï¼šä¸éœ€è¦ `TSRootBinaries`ï¼ˆRootHelper æ–¹æ¡ˆå·²åºŸå¼ƒï¼‰

---

## 3. æ ¸å¿ƒä»£ç å®ç°

### 3.1 å®šä½å¾®ä¿¡å®¹å™¨ï¼ˆâœ… å·²å®ç°å¹¶éªŒè¯ï¼‰

**æ–‡ä»¶**ï¼š`Services/WechatService.swift`

```swift
/**
 * åŠŸèƒ½æè¿°: é€šè¿‡ Bundle ID å®šä½å¾®ä¿¡åº”ç”¨çš„æ•°æ®å®¹å™¨
 * è¯´æ˜: ä½¿ç”¨ container-manager entitlement ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦ root æƒé™
 * Returns: å¾®ä¿¡å®¹å™¨å®Œæ•´è·¯å¾„ï¼Œæœªæ‰¾åˆ°è¿”å› nil
 */
static func findWechatContainer() -> String? {
    let fm = FileManager.default
    let basePath = "/var/mobile/Containers/Data/Application/"
    
    // ä½¿ç”¨ container-manager entitlement ç›´æ¥è¯»å–
    guard let containers = try? fm.contentsOfDirectory(atPath: basePath) else {
        print("âŒ æ— æ³•è¯»å–å®¹å™¨ç›®å½•")
        return nil
    }
    
    print("âœ“ æˆåŠŸè¯»å– \(containers.count) ä¸ªå®¹å™¨")
    
    for uuid in containers {
        let metadataPath = "\(basePath)\(uuid)/.com.apple.mobile_container_manager.metadata.plist"
        
        if let metadata = NSDictionary(contentsOfFile: metadataPath),
           let bundleID = metadata["MCMMetadataIdentifier"] as? String,
           bundleID == "com.tencent.xin" {
            
            let containerPath = "\(basePath)\(uuid)"
            print("âœ… æ‰¾åˆ°å¾®ä¿¡å®¹å™¨: \(containerPath)")
            return containerPath
        }
    }
    
    print("âŒ æœªæ‰¾åˆ°å¾®ä¿¡å®¹å™¨")
    return nil
}
```

**éªŒè¯ç»“æœ**ï¼š
```
âœ“ æˆåŠŸè¯»å– 208 ä¸ªå®¹å™¨
âœ… æ‰¾åˆ°å¾®ä¿¡å®¹å™¨: /var/mobile/Containers/Data/Application/91FC0093-DD75-4AA3-BC68-27956F0DD056
```

### 3.2 æŸ¥æ‰¾æœ€æ–°è§†é¢‘ç¼“å­˜ï¼ˆâš ï¸ å¾…å®ç°ï¼‰

```swift
/**
 * åŠŸèƒ½æè¿°: åœ¨å¾®ä¿¡ tmp ç›®å½•æŸ¥æ‰¾æœ€æ–°çš„ LocalShortVideo æ–‡ä»¶
 * Args:
 *     tmpPath: å¾®ä¿¡ tmp ç›®å½•è·¯å¾„
 * Returns:
 *     æœ€æ–°è§†é¢‘æ–‡ä»¶åï¼Œæœªæ‰¾åˆ°è¿”å› nil
 */
static func findLatestVideoCache(in tmpPath: String) -> String? {
    let fm = FileManager.default
    
    guard let files = try? fm.contentsOfDirectory(atPath: tmpPath) else {
        return nil
    }
    
    // ç­›é€‰ LocalShortVideo å¼€å¤´çš„æ–‡ä»¶
    let videoFiles = files.filter { $0.hasPrefix("LocalShortVideo") }
    
    guard !videoFiles.isEmpty else {
        return nil
    }
    
    // æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åº
    let sortedFiles = videoFiles.sorted { file1, file2 in
        let path1 = "\(tmpPath)/\(file1)"
        let path2 = "\(tmpPath)/\(file2)"
        
        let attr1 = try? fm.attributesOfItem(atPath: path1)
        let attr2 = try? fm.attributesOfItem(atPath: path2)
        
        let date1 = attr1?[.creationDate] as? Date ?? Date.distantPast
        let date2 = attr2?[.creationDate] as? Date ?? Date.distantPast
        
        return date1 > date2  // æœ€æ–°çš„åœ¨å‰
    }
    
    return sortedFiles.first
}
```

### 3.3 æ‰§è¡Œæ–‡ä»¶æ›¿æ¢ï¼ˆâš ï¸ å¾…å®ç°ï¼‰

```swift
/**
 * åŠŸèƒ½æè¿°: æ‰§è¡Œè§†é¢‘æ–‡ä»¶æ›¿æ¢æ“ä½œ
 * Args:
 *     ourFileName: æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶å (å¦‚: IMG_1234.MOV)
 *     cacheFileName: å¾®ä¿¡ç¼“å­˜æ–‡ä»¶å (å¦‚: LocalShortVideo_xxx.mp4)
 *     tmpPath: å¾®ä¿¡ tmp ç›®å½•è·¯å¾„
 * Returns:
 *     æ›¿æ¢æ˜¯å¦æˆåŠŸ
 */
static func replaceVideo(
    ourFileName: String,
    cacheFileName: String,
    in tmpPath: String
) -> Bool {
    let fm = FileManager.default
    let ourFilePath = "\(tmpPath)/\(ourFileName)"
    let cacheFilePath = "\(tmpPath)/\(cacheFileName)"
    let backupPath = "\(tmpPath)/backup_\(Date().timeIntervalSince1970).tmp"
    
    do {
        // 1. éªŒè¯æˆ‘ä»¬çš„æ–‡ä»¶å­˜åœ¨
        guard fm.fileExists(atPath: ourFilePath) else {
            print("âŒ æ‰¾ä¸åˆ°ä¸Šä¼ çš„æ–‡ä»¶: \(ourFileName)")
            return false
        }
        
        // 2. éªŒè¯å¾®ä¿¡ç¼“å­˜æ–‡ä»¶å­˜åœ¨
        guard fm.fileExists(atPath: cacheFilePath) else {
            print("âŒ æ‰¾ä¸åˆ°å¾®ä¿¡ç¼“å­˜æ–‡ä»¶: \(cacheFileName)")
            return false
        }
        
        // 3. å¤‡ä»½å¾®ä¿¡åŸå§‹ç¼“å­˜
        try fm.moveItem(atPath: cacheFilePath, toPath: backupPath)
        print("âœ“ å·²å¤‡ä»½: \(cacheFileName) â†’ backup")
        
        // 4. é‡å‘½åæˆ‘ä»¬çš„ç´ æä¸ºå¾®ä¿¡ç¼“å­˜çš„åç§°
        try fm.moveItem(atPath: ourFilePath, toPath: cacheFilePath)
        print("âœ“ å·²æ›¿æ¢: \(ourFileName) â†’ \(cacheFileName)")
        
        return true
    } catch {
        print("âŒ æ›¿æ¢å¤±è´¥: \(error)")
        
        // å°è¯•å›æ»š
        if fm.fileExists(atPath: backupPath) && !fm.fileExists(atPath: cacheFilePath) {
            try? fm.moveItem(atPath: backupPath, toPath: cacheFilePath)
            print("âœ“ å·²å›æ»šæ“ä½œ")
        }
        
        return false
    }
}
```

### 3.4 ä»ç›¸å†Œå¯¼å‡ºè§†é¢‘ï¼ˆâœ… å·²å®ç°ï¼‰

**æ–‡ä»¶**ï¼š`Services/VideoService.swift`

```swift
/**
 * åŠŸèƒ½æè¿°: ä»ç›¸å†Œå¯¼å‡ºè§†é¢‘åˆ°ä¸´æ—¶ç›®å½•
 * Args:
 *     assetID: PHAsset çš„ localIdentifier
 *     progress: å¯¼å‡ºè¿›åº¦å›è°ƒ (0.0 - 1.0)
 * Returns:
 *     Result<(path: String, fileName: String), Error>
 */
static func exportVideoFromPhotos(
    assetID: String,
    progress: ((Double) -> Void)? = nil
) -> Result<(path: String, fileName: String), Error> {
    // å®ç°ä»£ç ï¼ˆå·²åˆ›å»ºï¼‰
}
```

### 3.5 ä¸€é”®æ›¿æ¢å®Œæ•´æµç¨‹ï¼ˆâš ï¸ å¾…å®ç°ï¼‰

**æ–‡ä»¶**ï¼š`ViewModels/VideoViewModel.swift`

```swift
/**
 * åŠŸèƒ½æè¿°: ä¸€é”®æ›¿æ¢å®Œæ•´å®ç°ï¼ˆ7æ­¥æµç¨‹ï¼‰
 */
func oneClickReplace() {
    // æ­¥éª¤1: éªŒè¯æ˜¯å¦å·²é€‰æ‹©ç´ æ
    guard let savedVideo = VideoStorageManager.shared.load() else {
        updateStatus("è¯·å…ˆé€‰æ‹©ç´ æ")
        return
    }
    
    updateStatus("æ­£åœ¨ä»ç›¸å†Œå¯¼å‡ºç´ æ...")
    
    // æ­¥éª¤2: ä»ç›¸å†Œå¯¼å‡ºè§†é¢‘
    let result = VideoService.exportVideoFromPhotos(assetID: savedVideo.assetIdentifier)
    guard case .success(let (tempPath, fileName)) = result else {
        updateStatus("ä»ç›¸å†Œå¯¼å‡ºç´ æå¤±è´¥")
        return
    }
    
    updateStatus("æ­£åœ¨å®šä½å¾®ä¿¡å®¹å™¨...")
    
    // æ­¥éª¤3: å®šä½å¾®ä¿¡å®¹å™¨
    guard let wechatContainer = WechatService.findWechatContainer() else {
        updateStatus("æœªæ‰¾åˆ°å¾®ä¿¡åº”ç”¨æˆ–æ— æ³•è®¿é—®")
        return
    }
    
    let wechatTmpPath = "\(wechatContainer)/tmp"
    
    updateStatus("æ­£åœ¨ä¸Šä¼ ç´ æåˆ°å¾®ä¿¡...")
    
    // æ­¥éª¤4: ä¸Šä¼ ç´ æåˆ°å¾®ä¿¡ tmp
    let targetPath = "\(wechatTmpPath)/\(fileName)"
    do {
        if FileManager.default.fileExists(atPath: targetPath) {
            try FileManager.default.removeItem(atPath: targetPath)
        }
        try FileManager.default.copyItem(atPath: tempPath, toPath: targetPath)
        print("âœ“ å·²ä¸Šä¼ : \(fileName) â†’ å¾®ä¿¡tmp")
    } catch {
        updateStatus("ä¸Šä¼ ç´ æå¤±è´¥: \(error.localizedDescription)")
        return
    }
    
    updateStatus("æ­£åœ¨æŸ¥æ‰¾æœ€æ–°è§†é¢‘ç¼“å­˜...")
    
    // æ­¥éª¤5: æŸ¥æ‰¾å¾®ä¿¡æœ€æ–°ç¼“å­˜
    guard let latestCache = WechatService.findLatestVideoCache(in: wechatTmpPath) else {
        updateStatus("æœªæ‰¾åˆ°å¾®ä¿¡è§†é¢‘ç¼“å­˜ï¼Œè¯·å…ˆåœ¨å¾®ä¿¡ä¸­å½•åˆ¶è§†é¢‘")
        return
    }
    
    updateStatus("æ­£åœ¨æ‰§è¡Œæ–‡ä»¶æ›¿æ¢...")
    
    // æ­¥éª¤6: æ‰§è¡Œæ›¿æ¢
    let success = WechatService.replaceVideo(
        ourFileName: fileName,
        cacheFileName: latestCache,
        in: wechatTmpPath
    )
    
    // æ­¥éª¤7: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    try? FileManager.default.removeItem(atPath: tempPath)
    
    // æ˜¾ç¤ºç»“æœ
    if success {
        updateStatus("æ›¿æ¢æˆåŠŸï¼å¯ä»¥å»å¾®ä¿¡å‘å¸ƒäº† âœ“")
    } else {
        updateStatus("æ›¿æ¢å¤±è´¥")
    }
}
```

---

## 4. æ„å»ºå’Œæ‰“åŒ…

### 4.1 Xcode é…ç½®

**Build Settings**ï¼š
```
CODE_SIGNING_REQUIRED = NO
CODE_SIGNING_ALLOWED = NO
Code Signing Identity = ""
Code Signing Entitlements = $(PROJECT_DIR)/entitlements.plist
```

### 4.2 Makefile é…ç½®

**å…³é”®éƒ¨åˆ†**ï¼š

```makefile
# ç¼–è¯‘
archive:
	xcodebuild archive \
		-project WechatVideoReplacer.xcodeproj \
		-scheme WechatVideoReplacer \
		-archivePath $(ARCHIVE_PATH) \
		-configuration Release \
		CODE_SIGN_IDENTITY="" \
		CODE_SIGNING_REQUIRED=NO \
		CODE_SIGNING_ALLOWED=NO

# ç­¾åï¼ˆå…³é”®æ­¥éª¤ï¼‰
sign:
	@echo "=== Signing with ldid (Filza method) ==="
	
	# ç”¨ ldid ç­¾åä¸»åº”ç”¨
	ldid -SWechatVideoReplacer/entitlements.plist $(APP_PATH)/WechatVideoReplacer
	
	# éªŒè¯ entitlements å·²åµŒå…¥
	ldid -e $(APP_PATH)/WechatVideoReplacer | grep -E "container-manager|MobileContainerManager"
	
	# éªŒè¯æ— ç¦æ­¢çš„ entitlements
	if ldid -e $(APP_PATH)/WechatVideoReplacer | grep -q "cs.debugger\|skip-library-validation"; then \
		echo "âŒ ERROR: Banned entitlements found!"; \
		exit 1; \
	fi

# æ‰“åŒ…
package:
	@echo "=== Creating IPA ==="
	rm -rf $(BUILD_DIR)/Payload
	mkdir -p $(BUILD_DIR)/Payload
	cp -r $(APP_PATH) $(BUILD_DIR)/Payload/
	cd $(BUILD_DIR) && zip -qr WechatVideoReplacer.ipa Payload
```

### 4.3 æ„å»ºå‘½ä»¤

```bash
# å®Œæ•´æ„å»ºæµç¨‹
make clean      # æ¸…ç†
make all        # ç¼–è¯‘ + ç­¾å + æ‰“åŒ…

# å•ç‹¬æ‰§è¡Œ
make archive    # åªç¼–è¯‘
make sign       # åªç­¾å
make package    # åªæ‰“åŒ…
```

---

## 5. å·²å®Œæˆçš„ä»£ç 

### 5.1 æ•°æ®æ¨¡å‹

**æ–‡ä»¶**ï¼š`Models/SavedVideoInfo.swift`
- âœ… `SavedVideoInfo` ç»“æ„ä½“
- âœ… `VideoStorageManager` å•ä¾‹
- âœ… ä¿å­˜ã€åŠ è½½ã€æ¸…é™¤æ–¹æ³•
- âœ… æ ¼å¼åŒ–æ˜¾ç¤ºæ–¹æ³•

### 5.2 è§†é¢‘æœåŠ¡

**æ–‡ä»¶**ï¼š`Services/VideoService.swift`
- âœ… `requestPhotoLibraryAccess()` - è¯·æ±‚æƒé™
- âœ… `exportVideoFromPhotos()` - å¯¼å‡ºè§†é¢‘ï¼ˆä¿æŒæ–‡ä»¶åï¼‰
- âœ… `getVideoInfo()` - è·å–è§†é¢‘ä¿¡æ¯
- âœ… `VideoError` é”™è¯¯ç±»å‹å®šä¹‰

### 5.3 å¾®ä¿¡æœåŠ¡

**æ–‡ä»¶**ï¼š`Services/WechatService.swift`
- âœ… `findWechatContainer()` - å®šä½å®¹å™¨ï¼ˆç›´æ¥è®¿é—®ï¼‰
- âœ… `scanAllContainersDirect()` - è¯Šæ–­æ–¹æ³•
- âš ï¸ `findLatestVideoCache()` - å¾…æ·»åŠ 
- âš ï¸ `replaceVideo()` - å¾…æ·»åŠ 

### 5.4 å¸¸é‡å®šä¹‰

**æ–‡ä»¶**ï¼š`Utils/Constants.swift`
- âœ… `WechatConstants` - å¾®ä¿¡ç›¸å…³å¸¸é‡
- âœ… `StorageKeys` - å­˜å‚¨é”®
- âœ… `StatusMessages` - çŠ¶æ€æ¶ˆæ¯

---

## 6. å¾…å®ç°çš„åŠŸèƒ½

### 6.1 å¿…é¡»å®Œæˆçš„ä»»åŠ¡

#### é«˜ä¼˜å…ˆçº§

1. **æ¸…ç† RootHelper ä»£ç **
   - [ ] åˆ é™¤ `roothelper` binary
   - [ ] åˆ é™¤ `Services/RootHelperService.swift`
   - [ ] åˆ é™¤ `TSUtil.h` å’Œ `TSUtil.m`
   - [ ] åˆ é™¤ `WechatVideoReplacer-Bridging-Header.h`
   - [ ] æ¸…ç† `Info.plist` ä¸­çš„ `TSRootBinaries`
   - [ ] æ¸…ç† `WechatService.swift` ä¸­çš„ RootHelper å¼•ç”¨

2. **å®Œå–„ WechatService**
   - [ ] æ·»åŠ  `findLatestVideoCache()` æ–¹æ³•
   - [ ] æ·»åŠ  `replaceVideo()` æ–¹æ³•
   - [ ] ç§»é™¤ `scanAllContainers()` æ–¹æ³•ï¼ˆRootHelper æ–¹å¼ï¼‰
   - [ ] å®Œå–„é”™è¯¯å¤„ç†

3. **å®ç° VideoViewModel**
   - [ ] åˆ›å»º `ViewModels/VideoViewModel.swift`
   - [ ] å®ç° `oneClickReplace()` æ–¹æ³•ï¼ˆ7æ­¥æµç¨‹ï¼‰
   - [ ] å®ç°çŠ¶æ€ç®¡ç†
   - [ ] å®ç°è¿›åº¦å›è°ƒ

4. **é‡æ„ UI**
   - [ ] ç§»é™¤æµ‹è¯•æŒ‰é’®ï¼ˆ"è¯Šæ–­æ£€æŸ¥ (Root)" å’Œ "ç›´æ¥è®¿é—®æµ‹è¯•"ï¼‰
   - [ ] å®ç°ç´ æé€‰æ‹©æŒ‰é’®å’Œæ˜¾ç¤º
   - [ ] å®ç°ä¸€é”®æ›¿æ¢æŒ‰é’®
   - [ ] å®ç°è¿›åº¦æ˜¾ç¤º
   - [ ] å®ç°çŠ¶æ€æç¤º

#### ä¸­ä¼˜å…ˆçº§

5. **é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ**
   - [ ] å®Œå–„æ‰€æœ‰é”™è¯¯æç¤º
   - [ ] æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
   - [ ] æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
   - [ ] ä¼˜åŒ–ç•Œé¢å¸ƒå±€

6. **æµ‹è¯•å’ŒéªŒè¯**
   - [ ] åŠŸèƒ½æµ‹è¯•
   - [ ] é”™è¯¯åœºæ™¯æµ‹è¯•
   - [ ] æ€§èƒ½æµ‹è¯•

#### ä½ä¼˜å…ˆçº§

7. **æ–‡æ¡£å’Œäº¤ä»˜**
   - [ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£
   - [ ] å½•åˆ¶æ¼”ç¤ºè§†é¢‘
   - [ ] æ•´ç†æœ€ç»ˆäº¤ä»˜ç‰©

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### å…³é”®è¦ç‚¹

1. **æ–‡ä»¶åå¿…é¡»ä¿æŒ**
   - ä»ç›¸å†Œå¯¼å‡ºæ—¶ä¿æŒåŸæ–‡ä»¶å
   - ä¸Šä¼ åˆ°å¾®ä¿¡ tmp æ—¶ä¿æŒåŸæ–‡ä»¶å
   - é€šè¿‡æ–‡ä»¶åè¯†åˆ«æˆ‘ä»¬çš„æ–‡ä»¶

2. **é”™è¯¯å¤„ç†**
   - æ¯ä¸ªæ–‡ä»¶æ“ä½œéƒ½è¦ try-catch
   - æ›¿æ¢å¤±è´¥è¦è‡ªåŠ¨å›æ»š
   - æä¾›å‹å¥½çš„ä¸­æ–‡é”™è¯¯æç¤º

3. **çŠ¶æ€åé¦ˆ**
   - æ¯ä¸ªæ­¥éª¤æ›´æ–° UI çŠ¶æ€
   - æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ä¿¡æ¯
   - æˆåŠŸ/å¤±è´¥æ˜ç¡®æç¤º

4. **ä¸è¦ä½¿ç”¨ RootHelper**
   - ç›´æ¥è®¿é—®æ–¹å¼å·²éªŒè¯å¯ç”¨
   - RootHelper å¢åŠ å¤æ‚åº¦ä¸”ä¸éœ€è¦
   - æ‰€æœ‰ RootHelper ä»£ç éƒ½è¦ç§»é™¤

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å®Œæ•´
**æœ€åæ›´æ–°**ï¼š2025-01-10 23:30
