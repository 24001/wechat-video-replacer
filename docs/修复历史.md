# 修复历史

## 2025-11-15: 真机闪退问题完整修复

### 问题描述

应用在真机上出现以下问题：
1. **所有版本都闪退** - 无论使用哪个 IPA 版本
2. **点击弹窗任何按钮都闪退** - 验证、取消、购买卡密等
3. **首次能显示界面，但操作后就闪退**

### 根本原因分析

#### 1. Bundle Identifier 配置错误 ✅ 已修复
- **错误**: `com.yourcompany.WechatVideoReplacer` (占位符 ID)
- **影响**: TrollStore 可以安装，但 iOS 系统拒绝运行
- **修复**: 改为 `com.wechat.videoreplacer`
- **文件**: `WechatVideoReplacer.xcodeproj/project.pbxproj`

#### 2. 启动时执行网络测试 ✅ 已修复
- **错误**: `SceneDelegate.swift` 第 20-21 行调用 `testEncryption()`
- **影响**: 应用启动时就执行网络请求，真机环境可能失败导致状态异常
- **修复**: 完全移除启动测试代码
- **文件**: `WechatVideoReplacer/SceneDelegate.swift`

```diff
- // 🧪 测试加密功能
- testEncryption()
```

#### 3. 不当的退出方式 ✅ 已修复
- **错误**: 直接调用 `exit(0)`
- **影响**: iOS 真机会视为崩溃，触发崩溃保护
- **修复**: 先通知系统暂停，延迟后再退出
- **文件**: `WechatVideoReplacer/Views/LicenseViewController.swift`

```swift
// 旧代码
let cancelAction = UIAlertAction(title: "取消", style: .cancel) { _ in
    exit(0)
}

// 新代码
let cancelAction = UIAlertAction(title: "取消", style: .cancel) { [weak self] _ in
    UIControl().sendAction(#selector(URLSessionTask.suspend), to: UIApplication.shared, for: nil)
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
        exit(0)
    }
}
```

#### 4. 错误提示不友好 ✅ 已修复
- **错误**: 直接显示服务器返回的技术错误信息
- **影响**: 用户看不懂调试信息
- **修复**: 添加错误码映射，显示用户友好的提示
- **文件**: `WechatVideoReplacer/Services/BSPHPService.swift`

新增功能：
```swift
/// 将服务器错误码翻译为用户友好的提示
private static func getUserFriendlyErrorMessage(errorCode: String, serverMessage: String) -> String {
    let errorMap: [String: String] = [
        "1001": "卡密不存在，请检查是否输入正确",
        "1002": "卡密已过期，请续费或购买新卡密",
        "1003": "卡密已被封禁，请联系客服",
        // ... 更多映射
    ]
    // ...
}
```

### 修改的文件清单

#### 1. 核心代码修改
- `WechatVideoReplacer/SceneDelegate.swift` - 移除启动测试
- `WechatVideoReplacer/Views/LicenseViewController.swift` - 优雅退出 + 简化错误提示
- `WechatVideoReplacer/Services/BSPHPService.swift` - 用户友好错误映射
- `WechatVideoReplacer.xcodeproj/project.pbxproj` - Bundle ID 修复

#### 2. 新增文件
- `WechatVideoReplacer/entitlements_safe.plist` - 保守权限配置
- `docs/修复历史.md` - 本文件

#### 3. 文档更新
- `README.md` - 更新安装说明
- `闪退问题修复说明.md` - 详细修复说明

### 测试结果

#### 修复前
- ❌ 应用能安装但启动闪退
- ❌ 即使能显示界面，点击任何按钮都闪退
- ❌ 错误提示显示调试信息

#### 修复后
- ✅ 应用正常启动
- ✅ 卡密验证弹窗正常显示
- ✅ 所有按钮都能正常响应
- ✅ 取消按钮优雅退出（不是崩溃）
- ✅ 错误提示用户友好

### 技术总结

这次修复暴露了几个关键问题：

1. **Bundle Identifier 的重要性**
   - 不能使用占位符或测试 ID
   - TrollStore 对 Bundle ID 有验证机制
   - 无效 ID 会导致系统拒绝运行

2. **网络请求的时机**
   - 不应在应用启动时就执行
   - 应延迟到用户主动触发
   - 避免网络问题导致状态异常

3. **iOS 真机的退出机制**
   - 直接 `exit(0)` 会被视为崩溃
   - 需要给系统时间清理资源
   - 应使用优雅退出方式

4. **用户体验优化**
   - 技术错误信息对用户无意义
   - 需要翻译为友好的提示
   - 提供明确的解决建议

### 相关文档

- [闪退问题修复说明.md](../闪退问题修复说明.md) - 详细修复过程
- [快速开始.md](../快速开始.md) - 安装和使用指南
- [iPhone安装指南.md](../iPhone安装指南.md) - TrollStore 安装步骤

---

## 2025-11-12: Base64 换行符问题修复

### 问题描述
- 模拟器验证成功，真机验证失败
- 错误提示：解密失败或签名验证失败

### 根本原因
- `base64EncodedData(options: [])` 在真机和模拟器行为不一致
- 真机 Release 模式可能包含换行符

### 修复方案
```swift
// Utils/String+Crypto.swift
let cleanResult = result?.replacingOccurrences(of: "\r", with: "")
                        .replacingOccurrences(of: "\n", with: "")
                        .trimmingCharacters(in: .whitespaces)
```

---

## 2025-11-11: URL 编码问题修复

### 问题描述
- BSPHP 签名验证失败
- 加号(+) 被服务器解析为空格

### 根本原因
- `application/x-www-form-urlencoded` 标准将 + 转为空格
- Base64 编码结果包含加号

### 修复方案
```swift
// 手动编码加号为 %2B
let urlEncoded = encryptedString.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed)?
    .replacingOccurrences(of: "+", with: "%2B") ?? encryptedString
```
