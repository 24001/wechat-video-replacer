# UIAlertController Callback æƒé™å¤±æ•ˆé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶
- **ç³»ç»Ÿè¯Šæ–­æŒ‰é’®**ï¼šç›´æ¥è°ƒç”¨ â†’ âœ… æˆåŠŸæ‰¾åˆ°å¾®ä¿¡å®¹å™¨
- **ä¸€é”®æ›¿æ¢æŒ‰é’®**ï¼šæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† â†’ ç”¨æˆ·ç¡®è®¤ â†’ âŒ æ‰¾ä¸åˆ°å¾®ä¿¡å®¹å™¨

### å…³é”®çŸ›ç›¾
ä¸¤ä¸ªåŠŸèƒ½è°ƒç”¨çš„æ˜¯**å®Œå…¨ç›¸åŒçš„ä»£ç ** `WechatService.getWechatTmpPath()`ï¼Œä½†ç»“æœä¸åŒï¼

## ğŸ” é—®é¢˜ç±»å‹

è¿™æ˜¯ **iOS ç§æœ‰ entitlements çš„æœªæ–‡æ¡£åŒ–é™åˆ¶é—®é¢˜**ã€‚

### è°ƒç”¨è·¯å¾„å¯¹æ¯”

```
ç³»ç»Ÿè¯Šæ–­ï¼ˆæˆåŠŸï¼‰ï¼š
Button Tap â†’ diagnosticTapped() [ä¸»çº¿ç¨‹]
  â†’ WechatService.diagnoseContainerAccess() [ä¸»çº¿ç¨‹]
  â†’ âœ… æˆåŠŸè®¿é—®å®¹å™¨

ä¸€é”®æ›¿æ¢ï¼ˆå¤±è´¥ï¼‰ï¼š
Button Tap â†’ replaceButtonTapped() [ä¸»çº¿ç¨‹]
  â†’ UIAlertController.present() [ä¸»çº¿ç¨‹]
  â†’ ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ›¿æ¢"
  â†’ UIAlertAction callback [ä¸»çº¿ç¨‹]  â† å…³é”®ç‚¹ï¼
  â†’ startReplace() â†’ executeOneClickReplace()
  â†’ WechatService.getWechatTmpPath()
  â†’ âŒ æƒé™å¤±æ•ˆï¼æ‰¾ä¸åˆ°å®¹å™¨
```

### æ ¹æœ¬åŸå› ï¼ˆæ¨æµ‹ï¼‰

iOS çš„ç§æœ‰ entitlementsï¼ˆå¦‚ `com.apple.private.MobileContainerManager.allowed`ï¼‰å¯èƒ½æœ‰ä»¥ä¸‹é™åˆ¶ï¼š

1. **è°ƒç”¨æ ˆæ£€æŸ¥**ï¼šç³»ç»Ÿæ£€æµ‹åˆ°æ˜¯ä» UI callback è°ƒç”¨çš„
2. **Runloop Mode é™åˆ¶**ï¼šUIAlertController å¯èƒ½æ”¹å˜äº† runloop mode
3. **Security Scope ç”Ÿå‘½å‘¨æœŸ**ï¼šæƒé™çš„æœ‰æ•ˆèŒƒå›´å¯èƒ½åœ¨æ˜¾ç¤º alert æ—¶è¢«æš‚åœ
4. **TCC (Transparency, Consent, Control) é™åˆ¶**ï¼šæŸäº›ç§æœ‰æƒé™å¯èƒ½ç¦æ­¢åœ¨ç‰¹å®š callback ä¸­ä½¿ç”¨

**é‡è¦**ï¼šè™½ç„¶ä¸¤æ¬¡è°ƒç”¨éƒ½åœ¨ä¸»çº¿ç¨‹ï¼Œä½† iOS å¯èƒ½æ ¹æ®è°ƒç”¨ä¸Šä¸‹æ–‡ï¼ˆç›´æ¥è°ƒç”¨ vs UI callbackï¼‰æ¥å†³å®šæ˜¯å¦æˆäºˆæƒé™ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯ï¼šæå‰ç¼“å­˜ï¼ˆPre-fetchï¼‰

**åœ¨æ˜¾ç¤º UIAlertController ä¹‹å‰å°±è·å–å¹¶ç¼“å­˜å¾®ä¿¡å®¹å™¨è·¯å¾„**ï¼Œè¿™æ ·åœ¨ callback ä¸­å°±ä¸éœ€è¦é‡æ–°è·å–æƒé™äº†ã€‚

### ä»£ç ä¿®æ”¹

#### 1. VideoViewModel.swift - æ·»åŠ ç¼“å­˜æœºåˆ¶

```swift
class VideoViewModel {
    // ...
    
    /// å¾®ä¿¡å®¹å™¨è·¯å¾„ç¼“å­˜ï¼ˆè§£å†³ UIAlertController callback æƒé™é—®é¢˜ï¼‰
    private var cachedWechatTmpPath: String?
    
    /**
     * é¢„å…ˆè·å–å¹¶ç¼“å­˜å¾®ä¿¡å®¹å™¨è·¯å¾„
     * å¿…é¡»åœ¨æ˜¾ç¤º UIAlertController ä¹‹å‰è°ƒç”¨ï¼Œé¿å…æƒé™å¤±æ•ˆ
     */
    func prefetchWechatPath() -> Bool {
        print("ğŸ” [Prefetch] é¢„å…ˆè·å–å¾®ä¿¡å®¹å™¨è·¯å¾„...")
        guard let path = WechatService.getWechatTmpPath() else {
            print("âŒ [Prefetch] å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¾®ä¿¡åº”ç”¨")
            cachedWechatTmpPath = nil
            return false
        }
        cachedWechatTmpPath = path
        print("âœ… [Prefetch] æˆåŠŸï¼šè·¯å¾„å·²ç¼“å­˜")
        return true
    }
}
```

#### 2. VideoViewModel.swift - executeOneClickReplace ä½¿ç”¨ç¼“å­˜

```swift
func executeOneClickReplace(...) {
    // ...
    
    // æ­¥éª¤2A: ä½¿ç”¨é¢„å…ˆç¼“å­˜çš„å¾®ä¿¡å®¹å™¨è·¯å¾„
    // âš ï¸ é‡è¦ï¼šç”±äº iOS ç§æœ‰æƒé™å¯èƒ½ä¸å…è®¸åœ¨ UIAlertController callback ä¸­ä½¿ç”¨
    //         æˆ‘ä»¬åœ¨æ˜¾ç¤º alert ä¹‹å‰å°±è·å–å¹¶ç¼“å­˜äº†è·¯å¾„
    let wechatTmpPath: String
    if let cachedPath = cachedWechatTmpPath {
        print("âœ… ä½¿ç”¨ç¼“å­˜è·¯å¾„")
        wechatTmpPath = cachedPath
    } else {
        // å›é€€æ–¹æ¡ˆï¼šå¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œå°è¯•ç›´æ¥è·å–
        guard let path = WechatService.getWechatTmpPath() else {
            // å¤±è´¥å¤„ç†...
            return
        }
        wechatTmpPath = path
    }
    
    // ç»§ç»­åç»­æ­¥éª¤...
}
```

#### 3. ViewController.swift - åœ¨æ˜¾ç¤º alert å‰é¢„å–

```swift
@objc private func replaceButtonTapped() {
    guard !isExecuting else { return }

    // âš ï¸ é‡è¦ï¼šåœ¨æ˜¾ç¤º alert ä¹‹å‰é¢„å…ˆè·å–å¹¶ç¼“å­˜å¾®ä¿¡è·¯å¾„
    // iOS ç§æœ‰æƒé™å¯èƒ½ä¸å…è®¸åœ¨ UIAlertController callback ä¸­ä½¿ç”¨
    print("ğŸ” [Replace] é¢„å…ˆè·å–å¹¶ç¼“å­˜å¾®ä¿¡å®¹å™¨è·¯å¾„...")
    guard viewModel.prefetchWechatPath() else {
        print("âŒ [Replace] æ‰¾ä¸åˆ°å¾®ä¿¡åº”ç”¨")
        showAlert(title: "é”™è¯¯", message: "æ‰¾ä¸åˆ°å¾®ä¿¡åº”ç”¨ï¼Œè¯·ç¡®ä¿å¾®ä¿¡å·²å®‰è£…")
        return
    }
    print("âœ… [Replace] å¾®ä¿¡å®¹å™¨è·¯å¾„å·²ç¼“å­˜ï¼Œå¯ä»¥æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†")

    // ç°åœ¨å¯ä»¥å®‰å…¨åœ°æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†äº†
    let alert = UIAlertController(...)
    // ...
    present(alert, animated: true)
}
```

## ğŸ“Š è§£å†³æ•ˆæœ

### ä¿®æ”¹å‰
```
ä¸€é”®æ›¿æ¢æŒ‰é’®
  â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  â†“
ç”¨æˆ·ç‚¹å‡»ç¡®è®¤
  â†“
å°è¯•è·å–å¾®ä¿¡è·¯å¾„ â†’ âŒ æƒé™å¤±æ•ˆ
```

### ä¿®æ”¹å
```
ä¸€é”®æ›¿æ¢æŒ‰é’®
  â†“
é¢„å…ˆè·å–å¾®ä¿¡è·¯å¾„ â†’ âœ… æƒé™æœ‰æ•ˆ â†’ ç¼“å­˜è·¯å¾„
  â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  â†“
ç”¨æˆ·ç‚¹å‡»ç¡®è®¤
  â†“
ä½¿ç”¨ç¼“å­˜çš„è·¯å¾„ â†’ âœ… æˆåŠŸï¼
```

## ğŸ¯ å…³é”®è¦ç‚¹

1. **æ—¶æœºè‡³å…³é‡è¦**ï¼šå¿…é¡»åœ¨æ˜¾ç¤º UIAlertController **ä¹‹å‰** è·å–æƒé™
2. **ç¼“å­˜æ˜¯å¿…é¡»çš„**ï¼šä¸èƒ½åœ¨ callback ä¸­é‡æ–°è·å–æƒé™
3. **å›é€€æ–¹æ¡ˆ**ï¼šå¦‚æœç¼“å­˜å¤±è´¥ï¼Œä»ç„¶å°è¯•ç›´æ¥è·å–ï¼ˆä½œä¸º fallbackï¼‰
4. **æ—¥å¿—å¾ˆé‡è¦**ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—å¸®åŠ©è°ƒè¯•ç±»ä¼¼é—®é¢˜

## ğŸ“ ç½‘ç»œæœç´¢ç»“æœ

æœç´¢äº†å¤šä¸ªå…³é”®è¯ç»„åˆï¼Œä½†**æ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼æ¡ˆä¾‹**ï¼š
- iOS private entitlements UIAlertController callback
- FileManager contentsOfDirectory permission denied after UIAlertController
- iOS entitlements access denied after alert dialog

è¿™è¯´æ˜è¿™ä¸ªé—®é¢˜éå¸¸ç½•è§ï¼Œå¯èƒ½æ˜¯å› ä¸ºï¼š
1. å¾ˆå°‘æœ‰åº”ç”¨ä½¿ç”¨ç§æœ‰ entitlementsï¼ˆéœ€è¦ TrollStoreï¼‰
2. ä½¿ç”¨ç§æœ‰ entitlements çš„åº”ç”¨å¾ˆå°‘ä¼šåœ¨ UIAlertController callback ä¸­è°ƒç”¨æ•æ„Ÿ API
3. è¿™å¯èƒ½æ˜¯ iOS çš„ä¸€ä¸ªæœªæ–‡æ¡£åŒ–çš„å®‰å…¨æœºåˆ¶

## ğŸ”§ å…¶ä»–å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼ˆæœªæµ‹è¯•ï¼‰

### æ–¹æ¡ˆ2ï¼šå»¶è¿Ÿæ‰§è¡Œ
```swift
alert.addAction(UIAlertAction(title: "å¼€å§‹æ›¿æ¢", style: .default) { [weak self] _ in
    // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œè®© runloop å›åˆ°æ­£å¸¸ mode
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
        self?.startReplace()
    }
})
```

### æ–¹æ¡ˆ3ï¼šç§»é™¤ç¡®è®¤å¯¹è¯æ¡†
ç›´æ¥æ‰§è¡Œï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆç”¨æˆ·ä½“éªŒè¾ƒå·®ï¼‰ã€‚

### æ–¹æ¡ˆ4ï¼šä½¿ç”¨ UIAlertController çš„å…¶ä»–æ–¹å¼
å°è¯•ä½¿ç”¨ actionSheet è€Œä¸æ˜¯ alertï¼ˆç†è®ºä¸Šå¯èƒ½æœ‰ä¸åŒçš„æƒé™ä¸Šä¸‹æ–‡ï¼‰ã€‚

---

## ğŸ“š ç›¸å…³çŸ¥è¯†

### iOS æƒé™ç³»ç»Ÿå±‚æ¬¡

1. **BSD æƒé™** (EACCES) - ä¼ ç»Ÿ Unix æƒé™
2. **ACL (Access Control Lists)** - è®¿é—®æ§åˆ¶åˆ—è¡¨
3. **App Sandbox** (EPERM) - åº”ç”¨æ²™ç›’
4. **MAC (Mandatory Access Control)** - å¼ºåˆ¶è®¿é—®æ§åˆ¶
5. **TCC (Transparency, Consent, and Control)** - é€æ˜ã€åŒæ„å’Œæ§åˆ¶

æˆ‘ä»¬é‡åˆ°çš„æ˜¯ **MAC å±‚é¢çš„é™åˆ¶**ï¼ˆè¿”å› EPERMï¼‰ï¼Œè¿™æ˜¯æœ€åº•å±‚çš„å®‰å…¨æœºåˆ¶ã€‚

### ç§æœ‰ Entitlements çš„ç‰¹æ®Šæ€§

ç§æœ‰ entitlementsï¼ˆå¦‚ `com.apple.private.*`ï¼‰æ˜¯ Apple å†…éƒ¨ä½¿ç”¨çš„æƒé™ï¼Œä¸å¯¹å¤–å¼€æ”¾ï¼š
- åªæœ‰ç³»ç»Ÿåº”ç”¨å’Œç‰¹æ®Šåœºæ™¯ï¼ˆå¦‚ TrollStore æ³¨å…¥ï¼‰æ‰èƒ½ä½¿ç”¨
- è¡Œä¸ºæœªæ–‡æ¡£åŒ–ï¼Œå¯èƒ½éš iOS ç‰ˆæœ¬å˜åŒ–
- å¯èƒ½æœ‰éšè—çš„ä½¿ç”¨é™åˆ¶å’Œä¸Šä¸‹æ–‡è¦æ±‚

### TrollStore çš„å·¥ä½œåŸç†

TrollStore åˆ©ç”¨ CoreTrust bug ç»•è¿‡ç­¾åæ£€æŸ¥ï¼Œå…è®¸ï¼š
- æ°¸ä¹…å®‰è£… IPA
- ä½¿ç”¨ä»»æ„ entitlements
- ä¸éœ€è¦è¶Šç‹±

ä½†è¿™ä¸æ„å‘³ç€æ‰€æœ‰ entitlements åœ¨æ‰€æœ‰åœºæ™¯ä¸‹éƒ½æœ‰æ•ˆï¼ŒiOS å¯èƒ½æœ‰é¢å¤–çš„è¿è¡Œæ—¶æ£€æŸ¥ã€‚

---

**æ€»ç»“**ï¼šè¿™æ˜¯ä¸€ä¸ªéå¸¸ç½•è§çš„ iOS ç§æœ‰æƒé™ä¸ UI callback äº¤äº’çš„é—®é¢˜ï¼Œé€šè¿‡æå‰ç¼“å­˜è·¯å¾„æˆåŠŸè§„é¿äº†æƒé™é™åˆ¶ã€‚
