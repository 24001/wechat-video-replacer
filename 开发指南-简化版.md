# å¾®ä¿¡è§†é¢‘æ›¿æ¢å·¥å…· - å¼€å‘æŒ‡å—ï¼ˆç®€åŒ–ç‰ˆï¼‰

> åŸºäºæˆåŠŸéªŒè¯çš„å®¹å™¨è®¿é—®æ–¹æ¡ˆ

## âœ… å·²éªŒè¯å¯ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆ

### 1. å®¹å™¨è®¿é—®æ–¹å¼
- âœ… **ç›´æ¥è®¿é—®**ï¼ˆä½¿ç”¨ entitlementsï¼‰
- âŒ ~~RootHelper æ–¹å¼~~ï¼ˆä¸éœ€è¦ï¼‰

### 2. æƒé™é…ç½®ï¼ˆå·²éªŒè¯ï¼‰

**entitlements.plistï¼ˆå®Œæ•´é…ç½®ï¼‰ï¼š**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.private.security.container-required</key>
    <false/>
    
    <key>platform-application</key>
    <true/>
    
    <key>com.apple.security.exception.files.absolute-path.read-write</key>
    <array>
        <string>/</string>
    </array>
    
    <key>com.apple.security.files.all</key>
    <true/>
    
    <key>com.apple.private.security.no-container</key>
    <true/>
    
    <key>com.apple.private.security.storage.AppDataContainers</key>
    <true/>
    
    <key>com.apple.private.security.container-manager</key>
    <true/>
    
    <key>com.apple.private.MobileContainerManager.allowed</key>
    <true/>
    
    <key>com.apple.security.files.user-selected.read-only</key>
    <true/>
    
    <key>com.apple.security.files.user-selected.read-write</key>
    <true/>
    
    <key>com.apple.security.files.root.read-only</key>
    <true/>
    
    <key>com.apple.security.files.root.read-write</key>
    <true/>
    
    <key>com.apple.security.application-groups</key>
    <array>
        <string>*</string>
    </array>
    
    <key>task_for_pid-allow</key>
    <true/>
    
    <key>get-task-allow</key>
    <true/>
    
    <key>com.apple.private.security.no-sandbox</key>
    <true/>
    
    <key>com.apple.private.persona-mgmt</key>
    <true/>
</dict>
</plist>
```

**âš ï¸ ç¦æ­¢ä½¿ç”¨ï¼ˆä¼šé—ªé€€ï¼‰ï¼š**
- âŒ `com.apple.private.cs.debugger`
- âŒ `com.apple.private.skip-library-validation`
- âŒ `dynamic-codesigning`

### 3. ç¼–è¯‘å’Œç­¾åé…ç½®

**Xcode Build Settingsï¼š**
```
CODE_SIGNING_REQUIRED = NO
CODE_SIGNING_ALLOWED = NO
Code Signing Identity = ""
Code Signing Entitlements = $(PROJECT_DIR)/entitlements.plist
```

**ä½¿ç”¨ ldid ç­¾åï¼ˆMakefileï¼‰ï¼š**
```makefile
sign:
	# ç”¨ ldid ç­¾åä¸»åº”ç”¨
	ldid -SWechatVideoReplacer/entitlements.plist $(APP_PATH)/WechatVideoReplacer
	
	# éªŒè¯ entitlements å·²åµŒå…¥
	ldid -e $(APP_PATH)/WechatVideoReplacer | grep "container-manager"
```

---

## ğŸ“‹ å¼€å‘ä»»åŠ¡æ¸…å•

### é˜¶æ®µ1: æ¸…ç†é¡¹ç›® âœ…
- [x] ç§»é™¤ RootHelper ç›¸å…³ä»£ç 
  - åˆ é™¤ `roothelper` binary
  - åˆ é™¤ `RootHelperService.swift`
  - åˆ é™¤ `TSUtil.h/m`
  - åˆ é™¤ Info.plist ä¸­çš„ `TSRootBinaries`
  
- [x] ç§»é™¤æµ‹è¯•æŒ‰é’®
  - åˆ é™¤ "è¯Šæ–­æ£€æŸ¥ (Root)" æŒ‰é’®
  - ä¿ç•™å¹¶é‡æ„ WechatService çš„ç›´æ¥è®¿é—®æ–¹æ³•

### é˜¶æ®µ2: å®ç°æ ¸å¿ƒåŠŸèƒ½
- [ ] æ•°æ®æ¨¡å‹
  - `SavedVideoInfo.swift` - ç´ æä¿¡æ¯
  - `VideoStorageManager` - æŒä¹…åŒ–ç®¡ç†

- [ ] è§†é¢‘æœåŠ¡
  - `VideoService.swift` - ç›¸å†Œé€‰æ‹©å’Œå¯¼å‡º
  - è¯·æ±‚ç›¸å†Œæƒé™
  - ä» PHAsset å¯¼å‡ºè§†é¢‘ï¼ˆä¿æŒæ–‡ä»¶åï¼‰
  - è·å–è§†é¢‘ä¿¡æ¯

- [ ] å¾®ä¿¡æœåŠ¡
  - `WechatService.swift` - å®¹å™¨æ“ä½œ
  - å®šä½å¾®ä¿¡å®¹å™¨ï¼ˆç›´æ¥è®¿é—®ï¼‰
  - æŸ¥æ‰¾æœ€æ–° LocalShortVideo ç¼“å­˜
  - æ‰§è¡Œæ–‡ä»¶æ›¿æ¢

- [ ] ViewModel
  - `VideoViewModel.swift` - ä¸€é”®æ›¿æ¢æµç¨‹
  - å®Œæ•´çš„ 7 æ­¥æµç¨‹
  - çŠ¶æ€ç®¡ç†
  - é”™è¯¯å¤„ç†

- [ ] UI
  - é‡æ„ `ViewController.swift`
  - ç´ æé€‰æ‹©å’Œæ˜¾ç¤º
  - ä¸€é”®æ›¿æ¢æŒ‰é’®
  - è¿›åº¦åé¦ˆ
  - çŠ¶æ€æç¤º

### é˜¶æ®µ3: æµ‹è¯•å’Œæ‰“åŒ…
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ‰“åŒ… IPA
- [ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£

---

## ğŸ”‘ æ ¸å¿ƒä»£ç å®ç°

### 1. å®šä½å¾®ä¿¡å®¹å™¨ï¼ˆå·²éªŒè¯å¯ç”¨ï¼‰

```swift
static func findWechatContainer() -> String? {
    let fm = FileManager.default
    let basePath = "/var/mobile/Containers/Data/Application/"
    
    guard let containers = try? fm.contentsOfDirectory(atPath: basePath) else {
        return nil
    }
    
    for uuid in containers {
        let metadataPath = "\(basePath)\(uuid)/.com.apple.mobile_container_manager.metadata.plist"
        
        if let metadata = NSDictionary(contentsOfFile: metadataPath),
           let bundleID = metadata["MCMMetadataIdentifier"] as? String,
           bundleID == "com.tencent.xin" {
            return "\(basePath)\(uuid)"
        }
    }
    return nil
}
```

### 2. æŸ¥æ‰¾æœ€æ–°ç¼“å­˜

```swift
static func findLatestVideoCache(in tmpPath: String) -> String? {
    let fm = FileManager.default
    
    guard let files = try? fm.contentsOfDirectory(atPath: tmpPath) else {
        return nil
    }
    
    let videoFiles = files.filter { $0.hasPrefix("LocalShortVideo") }
    
    let sortedFiles = videoFiles.sorted { file1, file2 in
        let path1 = "\(tmpPath)/\(file1)"
        let path2 = "\(tmpPath)/\(file2)"
        
        let attr1 = try? fm.attributesOfItem(atPath: path1)
        let attr2 = try? fm.attributesOfItem(atPath: path2)
        
        let date1 = attr1?[.creationDate] as? Date ?? Date.distantPast
        let date2 = attr2?[.creationDate] as? Date ?? Date.distantPast
        
        return date1 > date2
    }
    
    return sortedFiles.first
}
```

### 3. æ–‡ä»¶æ›¿æ¢

```swift
static func replaceVideo(
    ourFileName: String,
    cacheFileName: String,
    in tmpPath: String
) -> Bool {
    let fm = FileManager.default
    let ourFilePath = "\(tmpPath)/\(ourFileName)"
    let cacheFilePath = "\(tmpPath)/\(cacheFileName)"
    let backupPath = "\(tmpPath)/backup_\(Date().timeIntervalSince1970).tmp"
    
    do {
        guard fm.fileExists(atPath: ourFilePath) else {
            return false
        }
        
        guard fm.fileExists(atPath: cacheFilePath) else {
            return false
        }
        
        // å¤‡ä»½
        try fm.moveItem(atPath: cacheFilePath, toPath: backupPath)
        
        // æ›¿æ¢
        try fm.moveItem(atPath: ourFilePath, toPath: cacheFilePath)
        
        return true
    } catch {
        // å›æ»š
        if fm.fileExists(atPath: backupPath) && !fm.fileExists(atPath: cacheFilePath) {
            try? fm.moveItem(atPath: backupPath, toPath: cacheFilePath)
        }
        return false
    }
}
```

---

## ğŸ“¦ æ‰“åŒ…æµç¨‹

### Makefile é…ç½®

```makefile
sign:
	@echo "=== Signing with ldid (Filza method) ==="
	
	# ç­¾åä¸»åº”ç”¨
	ldid -SWechatVideoReplacer/entitlements.plist $(APP_PATH)/WechatVideoReplacer
	
	# éªŒè¯ entitlements
	ldid -e $(APP_PATH)/WechatVideoReplacer | grep -E "container-manager|MobileContainerManager"
	
	# éªŒè¯æ— ç¦æ­¢çš„ entitlements
	if ldid -e $(APP_PATH)/WechatVideoReplacer | grep -q "cs.debugger\|skip-library-validation"; then \
		echo "âŒ ERROR: Banned entitlements found!"; \
		exit 1; \
	fi

package:
	@echo "=== Creating IPA ==="
	rm -rf $(BUILD_DIR)/Payload
	mkdir -p $(BUILD_DIR)/Payload
	cp -r $(APP_PATH) $(BUILD_DIR)/Payload/
	cd $(BUILD_DIR) && zip -qr WechatVideoReplacer.ipa Payload
```

### ç¼–è¯‘å‘½ä»¤

```bash
# æ¸…ç†
make clean

# ç¼–è¯‘ã€ç­¾åã€æ‰“åŒ…
make all

# IPA è¾“å‡ºåˆ° build/WechatVideoReplacer.ipa
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### å¿…é¡»é€šè¿‡çš„æµ‹è¯•

1. âœ… **åº”ç”¨èƒ½æ­£å¸¸å¯åŠ¨**ï¼ˆä¸é—ªé€€ï¼‰
2. âœ… **èƒ½è®¿é—®å¾®ä¿¡å®¹å™¨**ï¼ˆä¸æŠ¥æƒé™é”™è¯¯ï¼‰
3. âœ… **èƒ½é€‰æ‹©è§†é¢‘ç´ æ**
4. âœ… **èƒ½ä»ç›¸å†Œå¯¼å‡ºè§†é¢‘**ï¼ˆä¿æŒæ–‡ä»¶åï¼‰
5. âœ… **èƒ½å®šä½å¾®ä¿¡å®¹å™¨**
6. âœ… **èƒ½ä¸Šä¼ ç´ æåˆ°å¾®ä¿¡ tmp**
7. âœ… **èƒ½æ‰¾åˆ°æœ€æ–° LocalShortVideo**
8. âœ… **èƒ½æˆåŠŸæ›¿æ¢æ–‡ä»¶**
9. âœ… **å¾®ä¿¡èƒ½å‘å¸ƒæ›¿æ¢åçš„è§†é¢‘**ï¼ˆæœ€ç»ˆç›®æ ‡ï¼ï¼‰

### é”™è¯¯å¤„ç†æµ‹è¯•

- æœªé€‰æ‹©ç´ æ â†’ æç¤º
- æœªå®‰è£…å¾®ä¿¡ â†’ æç¤º
- æœªæ‰¾åˆ°ç¼“å­˜ â†’ æç¤ºï¼ˆå»ºè®®å…ˆåœ¨å¾®ä¿¡å½•åˆ¶ï¼‰
- ç›¸å†Œæƒé™æ‹’ç» â†’ æç¤º
- æ–‡ä»¶æ“ä½œå¤±è´¥ â†’ æç¤ºå¹¶å›æ»š

---

## ğŸ’¡ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶åå¤„ç†ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
- âœ… ä»ç›¸å†Œå¯¼å‡ºæ—¶**å¿…é¡»ä¿æŒåŸæ–‡ä»¶å**
- âœ… ä¸Šä¼ åˆ°å¾®ä¿¡ tmp æ—¶**å¿…é¡»ä¿æŒåŸæ–‡ä»¶å**
- âŒ ä¸è¦ä¿®æ”¹æ–‡ä»¶å
- **åŸå› **ï¼šé€šè¿‡æ–‡ä»¶åè¯†åˆ«æˆ‘ä»¬çš„æ–‡ä»¶

### 2. é”™è¯¯å¤„ç†
- æ¯ä¸ªæ–‡ä»¶æ“ä½œéƒ½è¦ `try-catch`
- æ›¿æ¢å¤±è´¥è¦è‡ªåŠ¨å›æ»š
- æä¾›å‹å¥½çš„ä¸­æ–‡é”™è¯¯æç¤º

### 3. çŠ¶æ€åé¦ˆ
- æ¯ä¸ªæ­¥éª¤æ›´æ–° UI çŠ¶æ€
- æ˜¾ç¤ºè¯¦ç»†è¿›åº¦ä¿¡æ¯
- æˆåŠŸ/å¤±è´¥æ˜ç¡®æç¤º

### 4. æƒé™é…ç½®
- ç¡®ä¿ entitlements.plist é…ç½®æ­£ç¡®
- ç”¨ ldid ç­¾åï¼ˆä¸è¦ç”¨ Apple è¯ä¹¦ï¼‰
- é€šè¿‡ TrollStore å®‰è£…ï¼ˆå¿…é¡»ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ¸…ç†é¡¹ç›®**ï¼šç§»é™¤ RootHelper ç›¸å…³ä»£ç 
2. **å®ç°æ ¸å¿ƒåŠŸèƒ½**ï¼šæŒ‰ç…§ä»»åŠ¡æ¸…å•é€æ­¥å®ç°
3. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿æ¯ä¸ªåŠŸèƒ½éƒ½èƒ½æ­£å¸¸å·¥ä½œ
4. **æ‰“åŒ…äº¤ä»˜**ï¼šç”Ÿæˆæœ€ç»ˆ IPA

**å…³é”®ï¼šåŸºäºå·²éªŒè¯å¯ç”¨çš„ç›´æ¥è®¿é—®æ–¹å¼ï¼Œä¸è¦ä½¿ç”¨ RootHelperï¼**
